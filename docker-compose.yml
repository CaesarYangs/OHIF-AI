# Reference:
# - https://docs.docker.com/compose/compose-file
# - https://eclipsesource.com/blogs/2018/01/11/authenticating-reverse-proxy-with-keycloak/
services:
  # Exposed server that's handling incoming web requests
  ohif_viewer:
    build:
      # Project root
      context: ./Viewers/
      # Relative to context
      dockerfile: ./platform/app/.recipes/Nginx-Orthanc/dockerfile
    image: webapp:latest
    container_name: ohif_orthanc
    volumes:
      # Nginx config
      - ./Viewers/platform/app/.recipes/Nginx-Orthanc/config/nginx.conf:/etc/nginx/nginx.conf
      - ./Viewers/platform/app/.recipes/Nginx-Orthanc/config/.htpasswd:/etc/nginx/.htpasswd
      # Logs
      - ./Viewers/platform/app/.recipes/Nginx-Orthanc/logs/nginx:/var/logs/nginx
    ports:
      - "1025:1025" # SSL
      - "1026:1026" # Web
    depends_on:
      #   - keycloak
      - orthanc
    restart: on-failure

  # LINK: https://hub.docker.com/r/jodogne/orthanc-plugins/
  # TODO: Update to use Postgres
  # https://github.com/mrts/docker-postgresql-multiple-databases
  orthanc:
    image: jodogne/orthanc-plugins
    hostname: orthanc
    container_name: orthancPACS
    volumes:
      # Config
      - ./Viewers/platform/app/.recipes/Nginx-Orthanc/config/orthanc.json:/etc/orthanc/orthanc.json:ro
      # Persist data
      - ./Viewers/platform/app/.recipes/Nginx-Orthanc/volumes/orthanc-db/:/var/lib/orthanc/db/
    restart: unless-stopped
    ports:
      - "4242:4242" # Orthanc REST API
      - "8042:8042" # Orthanc HTTP

  monai_sam2:
    build:
      context: ./
      dockerfile: ./monai-label/Dockerfile
    image: monai
    container_name: monai_sam2
    # runtime: nvidia # 某些旧版 Docker 需要此行，现代版本建议通过 deploy 控制
    volumes:
      - ./monai-label/predictions:/code/predictions
      # 建议增加模型缓存路径挂载，避免每次重启都重新下载几GB的模型
      - ./monai-label/huggingface_cache:/root/.cache/huggingface
    environment:
      - CUDA_VISIBLE_DEVICES=0
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all
      # --- 关键修改 1: 解决国内连接 HuggingFace 失败的问题 ---
      - HF_ENDPOINT=https://hf-mirror.com
      # 强制应用识别 GPU (取决于 MONAI Label 内部实现，有时需要显式指定)
      - monailabel_device=cuda
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all # 或者 count: 1
              capabilities: [gpu]
    shm_size: "12gb" # SAM2 模型较大，建议稍微调大一些
    ports:
      - "8002:8002"
    depends_on:
      - ohif_viewer
      - orthanc
    restart: on-failure
